name: Build Gridiron Gazette

on:
  workflow_dispatch:
    inputs:
      week:
        description: "Override week (optional)"
        required: false
        default: "2"

jobs:
  build:
    runs-on: ubuntu-latest
    # If your secrets live in an Environment, uncomment & set name:
    environment:
      name: Production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install espn-api docxtpl python-docx python-dotenv pyyaml openai requests

      - name: Export repo Secrets & Variables to $GITHUB_ENV
        run: |
          echo "ESPN_S2=${{ secrets.ESPN_S2 }}" >> "$GITHUB_ENV"
          echo "SWID=${{ secrets.SWID }}" >> "$GITHUB_ENV"
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> "$GITHUB_ENV"
          echo "LEAGUE_ID=${{ vars.LEAGUE_ID }}" >> "$GITHUB_ENV"
          echo "YEAR=${{ vars.YEAR }}" >> "$GITHUB_ENV"
          echo "TEMPLATE=${{ vars.TEMPLATE }}" >> "$GITHUB_ENV"
          echo "OUTDOCX=${{ vars.OUTDOCX }}" >> "$GITHUB_ENV"
          echo "FANTASY_SEASON_START=${{ secrets.FANTASY_SEASON_START }}" >> "$GITHUB_ENV"

      - name: Fill missing env from gazette.yml
        run: |
          python - <<'PY'
          import os, pathlib, yaml
          p = pathlib.Path('gazette.yml')
          cfg = yaml.safe_load(p.read_text()) if p.exists() else {}
          def put(k, v):
              if v is None: return
              with open(os.environ['GITHUB_ENV'], 'a') as f:
                  print(f"{k}={v}", file=f)
          if not os.getenv('LEAGUE_ID') and cfg.get('league_id') is not None: put('LEAGUE_ID', cfg['league_id'])
          if not os.getenv('YEAR') and cfg.get('year') is not None: put('YEAR', cfg['year'])
          if not os.getenv('TEMPLATE') and cfg.get('template'): put('TEMPLATE', cfg['template'])
          if not os.getenv('OUTDOCX') and cfg.get('output_dir'): put('OUTDOCX', cfg['output_dir'])
          PY

      - name: Preflight (sanity print, no secrets)
        run: |
          python - <<'PY'
          import os, yaml, pathlib
          p = pathlib.Path('gazette.yml')
          cfg = yaml.safe_load(p.read_text()) if p.exists() else {}
          def safe(v): return f"present(len={len(v)})" if v else "missing"
          print("YAML present:", p.exists())
          print("LEAGUE_ID:", os.environ.get('LEAGUE_ID'))
          print("YEAR:", os.environ.get('YEAR'))
          print("TEMPLATE:", os.environ.get('TEMPLATE'))
          print("OUTDOCX:", os.environ.get('OUTDOCX'))
          print("ESPN_S2:", safe(os.environ.get('ESPN_S2')))
          print("SWID:", safe(os.environ.get('SWID')))
          print("OPENAI_API_KEY:", safe(os.environ.get('OPENAI_API_KEY')))
          PY

      - name: Run Gazette build
        run: |
          set -euo pipefail
          : "${TEMPLATE:=recap_template.docx}"
          : "${OUTDOCX:=recaps}"
          : "${YEAR:=2025}"
          PY_ARGS=()
          if [ -n "${{ github.event.inputs.week }}" ]; then PY_ARGS+=(--week "${{ github.event.inputs.week }}"); fi
          python build_gazette.py --llm-blurbs --verbose "${PY_ARGS[@]}"

      - name: Upload Gazette artifact
        uses: actions/upload-artifact@v4
        with:
          name: gazette
          path: |
            recaps/*.docx
            recaps/*.pdf
          if-no-files-found: warn
