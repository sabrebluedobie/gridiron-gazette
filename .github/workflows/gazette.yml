name: Build Gridiron Gazette

on:
  workflow_dispatch:
    inputs:
      week:
        description: "Week number (optional)"
        required: false
        default: ""

permissions:
  contents: write

env:
  # Secrets (repo Settings → Secrets and variables → Actions → Secrets)
  ESPN_S2: ${{ secrets.ESPN_S2 }}
  SWID: ${{ secrets.SWID }}                 # secret VALUE must include braces, e.g. {xxxxxxxx-...}

  # Variables (repo Settings → Secrets and variables → Actions → Variables)
  LEAGUE_ID: ${{ vars.LEAGUE_ID }}          # e.g., 887998
  YEAR: ${{ vars.YEAR }}                    # e.g., 2025
  TEMPLATE: ${{ vars.TEMPLATE }}            # e.g., recap_template.docx
  OUTDOCX: ${{ vars.OUTDOCX }}              # e.g., recaps/Week{week}_Gazette.docx
  TEAM_LOGOS_FILE: ${{ vars.TEAM_LOGOS_FILE }}  # e.g., team_logos.json

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Preflight (no secrets leak; fails if misconfigured)
        env:
          WEEK_INPUT: ${{ github.event.inputs.week }}
        run: |
          set -euo pipefail
          python espn_preflight.py

      - name: Build Gazette
        env:
          WEEK_INPUT: ${{ github.event.inputs.week }}
        run: |
          set -euo pipefail
          PY_ARGS=()
          if [ -n "${WEEK_INPUT:-}" ]; then
            PY_ARGS+=(--week "$WEEK_INPUT")
          fi
          python build_gazette.py --llm-blurbs --verbose "${PY_ARGS[@]}"

      - name: Upload recap
        uses: actions/upload-artifact@v4
        with:
          name: gazette-output
          path: recaps/*.docx
